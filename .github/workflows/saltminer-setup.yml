name: Package SaltMiner Setup

on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches:
    - main
    - '3.*'
    paths-ignore:
    - '.github/workflows/fleet-config.yml'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - run: |
        mkdir output
        cp .env output/
        cp -r config output/
        cp docker-compose.yml output/
        cp fleet.env output/
        cp paths-cloud.sh output/
    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v4.6.2
      with:
        name: saltminer-setup-${{ github.ref_name }}-${{ github.run_number }}
        path: ./output
        retention-days: 30
        # Needed for .env file
        include-hidden-files: true

  release:
    runs-on: ubuntu-latest

    steps:
    - name: Create Release
      env:
       GH_TOKEN: ${{ github.token }}
      run: |
        gh release create "v${{ github.ref_name }}-alpha.${{ github.run_number }}" \
          ./output/*.zip \
          --repo="$GITHUB_REPOSITORY" \
          --title="v${{ github.ref_name }}-alpha.${{ github.run_number }}" \
          --latest=false \
          --prerelease=true \
          --notes="SaltMiner v${{ github.ref_name }}-alpha.${{ github.run_number }} setup project."
